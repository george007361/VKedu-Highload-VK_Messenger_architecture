# VK Messenger
> Семестровое домашнее задание по курсу Highload. Технопарк ВК МГТУ им. Баумана, весна 2023. Илларионов Георгий WEB-31

> [Методические указания](https://github.com/init/highload/blob/main/homework_architecture.md)

## 1 Тема 
**VK Messenger** - сервис для обмена сообщениями между пользователями. Включает такие функции как: обмен текстовыми сообщениями, стикерами, голосовыми сообщениями и вложениями в личных и групповых чатах. Также имеется возможность совершать голосовые и видео- звонки и создавать конференции.

### MVP

Ключевой функционал мессенжера- обмен сообщениями в реальном времени.

1. Профиль пользователя 
2. Создание, удаление личных чатов
3. Отправка, редактирование, удаление сообщений
4. Возможность прикреплять вложения к сообщениям.
5. Возможность отправлять голосовые сообщения
6. Поиск пользователей
7. Функционал Multilogin не предусмотрен

### Целевая аудитория
- Суммарная аудитория 100 млн пользователей [^1] [^2]
- Месячная аудитория 76,9 млн пользователей [^1] [^2]
- Дневная аудитория 49,4 млн пользователей [^1] [^2]
- 15 млрд сообщений в день в среднем [^3]
- 33 млн пользователей в месяц пользуются голосовыми сообщениями [^3]
- Распределение по странам (Подавляющее большинство из стран СНГ): [^4]

| Страна | Посетителей в месяц |
| ------ | ------------------- |

|           | %    | Млн. чел. |
| --------- | ---- | --------- |
| Россия    | 65,7 | 50,5      |
| Украина   | 18,3 | 14,1      |
| Норвегия  | 5,6  | 4,3       |
| Беларусь  | 2,5  | 1,9       |
| Польша    | 1,7  | 1,3       |
| Казахстан | 1,1  | 0,8       |
| Остальные | 5    | 3,8       |

## 2 Расчёт нагрузки

### Продуктовые метрики
- Месячная аудитория - 76,9 млн. пользователей [^1] [^2] 
- Дневная аудитория - 49,4 млн. пользователей [^1] [^2]
- Ежедневно пользователи отправляют около 15 миллиардов сообщений [^3]
- Ежедневно пользователи создают более 3 миллионов чатов [^5]
- 33 млн пользователей ежемесячно используют голосовые сообщения [^1]

#### Среднее количество действий пользователя по типам в день

1. Регистрация новых пользователей в день: *0,078 млн. чел. в день*
   > Рост за месяц составил 2,4% [^1] [^2]
   
   > D - прирост пользователей за день, Х - Число пользователей в новом месяце, Y - Число пользователей в старом месяце
   
   > Y = X * (100% + 2,4%) = X * 1,024
   
   > X = Y / 1,024 = 97,66 млн. чел.
   
   > D = (Y - X) / 30 = 2,34 млн. чел. в мес. / 30 дней = 0,078 млн. чел. в день
   
   **RPS на регистрацию:** *0,9*
   > 0,078 * 1000000 / (24 * 60 * 60) = 0,9 
2. Авторизация пользователей в день: *15 раз*
   > Будем считать, что при посещении сервиса пользователь авторизуется раз в 3 месяца, получает куку и далее использует её. Получается, что в месяц выполняется 76,9 млн. / 3 = 26,6 млн. запросов авторизации или 0,0,85 млн. запросов в сутки

   **RPS на авторизацию:** *10*
   >  0,85 * 1000000 / (24 * 60 * 60) = 10
3. Создание диалогов в день: *0,06 раз*
   > В среднем за сутки создаётся 3 млн чатов [^5], получается, что каждый пользователь в день создаёт  3 / 49,4 = 0,06 чатов в день
   
   **RPS на создание чатов:** *35*
   > 3 * 1000000 / (24 * 60 * 60) = 34,7 = 35

4. Получение списка диалогов: *15 раз*
   > Полагаем, что запрос на получение списка диалогов происходит при каждом посещении мессенджера.
   
   > Пользователь заходит в мессенджеры в среднем 25 раз в день[^7], а доля ВК на рынке мессенджеров составляет 62% [^8], то есть на ВК по грубой оценке приходится около **15 посещений в сутки от одного пользователя** и при каждом посещении требуется получить список диалогов.

   **RPS на получение списка диалогов:** *8576*
   > 15 * 49.4 млн / (24 * 60 * 60) = 8576 
5. Удаление диалогов в день: предположим, что оно *пренебрежительно мало*
6. Отправка новых сообщений в день: *272 текстовых и 26 голосовых сообщения*
   > По статистике голосовыми сообщениями пользуется 33 млн пользователей [^1] из 76,9 млн [^1] ежемесячно. 
   
   > Тогда доля пользователей, использующих голосовые сообщения, есть 33 / 76,9 = 0,43, а не использующих ГС - 0,57.
   
   > Будем считать, что такое соотношение сохраняется ежедневно и каждый месяц.
   
   > Также предположим, что пользователи использующие ГС, отправляют его в 25% случаях, а в остальных 75% используют текстовые сообщения.
   
   > Пользователи, не использующие ГС, оправляют текстовые в 100% случаев.

   > Используя данные выше, определим вероятность того, что новое отправленное сообщение 
   
   > а) не является голосовым: 1 * 0,57 + 0,8 * 0,43 = 0,914
   
   > б) является голосовым: 0 * 0,57 + 0,2 * 0,43 = 0,086
   
   > Проверка: Сумма (а) и (б) = 1 - верно.  
   
   > Ежедневно пользователи отправляют около 15 млрд сообщений [^3], тогда каждый пользователь в среднем за сутки отправляет:
   
   > 0,914 * 15 млрд / 49,4 млн = 277 не голосовых сообщения
   
   > 0,086 * 15 млрд / 49,4 млн = 26 голосовых сообщения

   **RPS на отправку текстовых сообщений:** *158680*
   
   > 0,914 * 15 млрд / (24 * 60 * 60) = 158680
   
   **RPS на отправку голосовых сообщений:** *14930*
   > 0,086 * 15 млрд / (24 * 60 * 60) = 14930
7.  Загрузка новых вложений в день: *6*
    > Предположим что только 2% текстовых сообщений имеют вложения. Тогда в день пользователь в среднем загружает 272 * 0.02 = 6 вложений

    **RPS на загрузку вложений**: *3430*
    > 6 * 49,4 * 1000000 / (24 * 60 * 60) = 3430
8. Изменение отправленных сообщений в день: *28 сообщения*
   > Предположим, что в каждом десятом текстовом сообщении пользователь делает ошибку и исправляет его, тогда 10% * 277 = 28 редактирования в сутки на одного пользователя
   
   **RPS на изменение сообщения:** *16009*
   > 28 * 49,4 млн / (24 * 60 * 60) = 16009
9. Удаление отправленных сообщений в день: *3 сообщения*
   > Будем считать, что только 1% сообщений удаляется, тогда (277 + 26) * 1% = 3 сообщения удаляет пользователь в день.
   
   **RPS на удаление сообщений:** *1715*
   > 3 * 49,4 * 1000000 / (24 * 60 * 60) = 1715
10. Получение сообщений в диалоге: *110 раз*
    > Примем количество активных диалогов равным 5
    > Используем предположения из п.4, получаем: 15 раз в день * 5 активных диалогов = 80 запросов на получение сообщений в, когда пользователь заходит в мессенжер. При условии прочтения только последних сообщений (без пролистывания к более старым) это соответствует 80 * 10 = 800 сообщениям.

    > Из них согласно п. 0.086 * 800 = 69 голосовых сообщений, 69 запросов на получение голосового сообщения

    > Из них согласно п. 2% * 0.914 * 800 = 15 имеют вложения, 15 запросов на получение вложений

    > Также пользователь читает все новые сообщения: 272 текстовых и 26 голосовых (суммарно 298, при условии 5 активных чатов - 60 запросов на получение сообщений) согласно п.  

    > Из них согласно п. 0.086 * 298 = 26 голосовых сообщений, 26 запросов на получение голосового сообщения

    > Из них согласно п. 2% * 0.914 * 298 = 6 имеют вложения, 6 запросов на получение вложений

    **RPS на получение сообщений в диалоге**: *80 046*
    > (80 + 60) * 49,4 млн / (24 * 60 * 60) = 80 046

    **RPS на получение голосовых сообщений**: *54 317*
    > (69 + 26) * 49,4 млн / (24 * 60 * 60) = 54 317

    **RPS на получение вложений**: *12 006*
    > (15 + 6) * 49,4 млн / (24 * 60 * 60) = 12 006

11. Получение вложений из сообщений в день: *20 штук*
    > Из п.7 считаем, что **2% сообщений имеют вложения**, из п.4  имеем, что в день пользователь заходит в сервис и получает список диалогов **15 раз**. Будем считать, что в среднем пользователь имеет **5 активных диалогов**, в которых каждый раз проверяет последние сообщения, количество которых примем равным **10**.
   
    > Тогда в день пользователь получает  15 * 5 * 10 * 2% = 15 вложений, когда проверяет диалоги

    > Также, пользователель читает все новые сообщения. Каждый отравляет 272 текстовых сообщения в день , где 2% имеют вложения. Тогда каждый пользователь в день получает 272 * 2% * 49,4 млн / 49,4 млн = 5 вложених из новых сообщений.

    **RPS на получение вложений**: *11 435*
    > (15 + 5) * 49,4 млн / (24 * 60 * 60) = 11 435

12. Поиск пользователей за день: *0,06 раз*
   > Будем считать, что необходимость искать пользователя возникает при создании чата. Используем п.3: 0,06 раз за день пользователь создает диалог/чат, следовательно, столько же раз и выполняется поиск.  
   
   **RPS на поиск пользователей:** *35*

#### Сводная таблица RPS

**Среднее количество RPS по типовым действиям**
|   №   | Действие                      |  Тип   |  RPS   |
| :---: | ----------------------------- | :----: | :----: |
|   1   | Регистрация                   | Запись |   1    |
|   2   | Авторизация                   | Запись |   10   |
|   2   | Авторизация по куке           | Чтение | 257738 |
|   3   | Создание чата                 | Запись |   35   |
|   4   | Отправка текстового сообщения | Запись | 158680 |
|   5   | Отправка голосового сообщения | Запись | 14930  |
|   6   | Изменение сообщения           | Запись | 16009  |
|   7   | Удаление сообщений            | Запись |  1715  |
|   8   | Поиск пользователя            | Чтение |   35   |
|   9   | Получение списка диалогов     | Чтение |  8576  |
|  10   | Загрузка вложений             | Запись |  3430  |
|  11   | Получение вложений            | Чтение |  8576  |
|  11   | Получение сообщений в диалоге | Чтение | 45741  |

#### Суммарное RPS на чтение и на запись

- На чтение: 515 476 RPS
- На запись: 194 810 RPS

### Технические метрики
#### Средний размер хранилища пользователя
Предположим, что:
- **размер аватарки** пользователя *2 мб*
- **Имя и фамилия** пользователя занимает *14 байт* [^6]
  > 7 букв на имя + 7 букв на фамилию = 14 символов = *14 байт*
- **Информация о себе** *40 байт*
  > 40 символов = *40 байт*
Тогда данные одного пользователя занимают *2116 байт*

> 2 * 1024 + 14 + 14 + 40 = 2116 байт

#### Размер хранилища пользователей: *0,19 Тб*
> Тогда, суммарно на всех пользователей получается:

>  2116 * 100 * 10^6 = 211600000000 байт = 0,19 Тб

#### Размер хранения по типам данных
1. Текстовые сообщения: *13 981,5 Тб*
   > Используем п.4 продуктовых требований, откуда 0,914 * 15 млрд = 13,71 млрд текстовых сообщений в день отправляют все пользователи. 

   > Рассчитаем количество сообщений за 3 года, пренебрегая ростом аудитории и считая статистику отправки постоянной.

   > Получится 13,71 млрд * 365 * 3 = 15012,5 млрд сообщений за 3 года.

   > Принимая максимальную длину сообщений в 1024 символа, каждый символ - 1 байт, получится, что хранилище сообщений должно вмещать 
   15012,5 млрд * 1 кб = 13 981,5 Тб
2. Голосовые сообщения: *315 740,7 Тб*
   > Расчёты аналогичны предыдущему пункту

   > 0,086 * 15 млрд = 1,29 млрд сообщений в день

   > Расчёт выполняем за 3 года

   > Получаем: 1,29 млрд * 365 * 3 = 1412,6 млрд сообщений за 3 года

   > Принимаем среднюю длину голосового сообщения за 10 секунд, кодирование OGG (192 кбит / с), откуда вес одного ГС 1920 кбит

   > Итого 1412,6 млрд * 192 кбит = 315 740,7 Тб
3. Вложения в сообщениях: *286 331,2 Тб *
   > Из предположения п.9 продуктовых требований, 2% текстовых сообщений имеют вложения. Вложениями считаем фотографии средним весом 1 мб.

   > Расчёт выполняем за 3 года

   > Из п.1 технических расчетов имеем 15012,5  млрд сообщений за 3 года.

   > Тогда объем хранилища вложений составит 15012,5  млрд * 2% * 1мб = 300,24 млрд мб = 286 331,2 Тб 
#### Сетевой трафик
> Для расчёта используем RPS из продуктовых требований и размеры пакетов из технических метрик 
1. Регистрация: *Пренебрегаем*
   > 2116 байт * 1 RPS - пренебрежимо мало
2. Авторизация: *0,15 Гбит/с*
   > 2116 байт * 8576 RPS = 0,15 Гбит/с
3. Работа с текстовыми сообщениями:
 
   Создание: *1,27 Гбит/с*
   > 1 кб * 158680 RPS = 1,27 Гбит/с

   Изменение: *1,28 Гбит/с*
   > 1 кб * 16009 RPS = 1,28 Гбит/с

   Получение: *0,33 Гбит/с*
   > 1 кб * 98% * 0,914 * 45741 RPS = 0,33 Гбит/с
4. Работа с голосовыми сообщениями: 

   Создание: *43 Гбит/с*
   > 1920 кбит * 14930 RPS = 28,7 Гбит/с

   Получение: *11,33 Гбит/с*
   > 1920 кбит * 0,086 * 45741 RPS = 7,6 Гбит/с
5. Работа с вложениями в сообщениях:

   Загрузка: *54,88 Гбит/с*
   > 1 мб * 3430 RPS = 27,44 Гбит/с

   Получение: *137,216 Гбит/с*
   > 1 мб * 8576 RPS = 68,6 Гбит/с

## Логическая схема базы данных
![схема бд](/imgs/db_scheme.png)

Размер хранилища по таблицам:

1. Данные авторизации (cookies)
   > Предположим что у пользователя в среднем 2 устройства. \
   > Поля занимают: \
   > `id` 2 байта;  \
   > `user_id` 2 байта, \
   > `cookie` 16 байт, \
   > `expires` 8 байт. \
   > Число пользователей в месяц 77 млн. 
   
   77 млн * 2 * (2 + 2 + 64 + 8) = **11 Гб**
2. Данные пользователя (users)
   > Поля занимают:
   > `id` - 2 байт \
   > `first_name` - 64 байт \
   > `last_name` - 64 байт \
   > `email` - 256 байт \
   > `passwd_hash` - 128 байт \
   > `about` - 40 байт \
   > `avatar_uuid` - 16 байт

   100 млн * (2 + 64 + 64 + 256 + 128 + 40 + 16) = **53,28 Гб**

3. Данные чатов (chats)
   > Грубо предположим, что у каждого пользователя 40 чатов \ 
   > Поля занимают: \
   > `id` - 2 байт \
   > `user_1_id` - 2 байт \
   > `udser_2_id` - 2 байт

   100 млн * 40 * (2 + 2 + 2) = **22,38 Гб**
4. Данные сообщений (messages)
   > В среднем сообщение занимает 100 символов, т.е. 100 байт
   > Поля занимают: \
   > `id` - 8 байт \
   > `author_id` - 2 байт \
   > `chat_id` - 2 байт \
   > `create_date` - 8 байт \
   > `edit_date` - 8 байт \
   > `text_content` - 1024 байт максимум, 100 байт в среднем, 0 если это голосовое сообщение \
   > `voice_content_uuid` - 16 байт (или 0) \
   > `attachment_uuids` - 16 байт (или 16 * n, где n - число вложений) \

   Только текстовые: 
      13,71 млрд * (8 + 2 + 2 + 8 + 8 + 100) = 1634 Гб / день
   Голосовые: 
      1,29 млрд * (8 + 2 + 2 + 8 + 8 + 16) = 53 Гб / день
   Текстовые с вложениями:
      0,28 млрд * (8 + 2 + 2 + 8 + 8 + 100 + 16) = 38 Гб / день

   Итого: **1725 Гб / день**


## Физическая схема базы данных
### PostgreSQL
Хранение данных о `пользователях`, `сообщениях` и `чатах`. 

> Поддерживает обширный функционал, инструменты шардинга, а также популярна (а следовательно имеет хорошую поддержку).

Предусмотрим **репликацию** данных. Из-за большого объёма выберем схему master-slave. Master будет принимать операции записи, Slave - чтение. 

#### Шардирование и индексы
1. Таблица пользователей `users`
   Так как RPS авторизации (по полям `email` `passwd_hash`), поиска пользователей (`first_name` `last_name`) невелик, количество пользователей записей с частотой 1 RPS, а чтение данных происходит по `id` при каждом заходе в чат, то имеет смысл **шардирование по `id`** для уменьшения количества записей в таблице.

   Используем **индексы** для авторизации по составному ключу `email` + `passwd_hash` и **индексы** для поиска пользователей по ключам `lower(first_name)`, `lower(last_name)`, `(lower(first_name), lower(last_name))`. 

2. Таблица чатов `chats`
   Шардирование применять нецелесообразно. 
   Используем индексы по ключам `user_1_id`, `user_2_id` 
3. Таблица сообщений `messages`
   Сообщения накапливаются в хронологическом порядке по полю `create_date`. 
   Каждое сообщение привязано к соответствующему чату `chats` по полю `chat_id`.
   RPS на создание записей около 180 тыс. 
   RPS на поиск сообщений по `chat_id` 46 тыс.
   Стандартый сценарий использования - проверка последних сообщений, скроллинг вверх для просматривания более старых сообщений происходит гораздо реже.
   Выбираем **шардирование** по составному ключу `create_date` + `chat_id`

### Tarantool
Хранение `сессий` пользователей

> Tarantool - *in-memory* база данных, следовательно доступ к записям осуществляется со значительно большей скоростью. Поддерживает репликацию, позволяет горизонтально масштабироваться и предоставляет технологию Tarantool Cartrige и роутер, которые позволяют создать кластер и настроить роутинг быстро, удобно  и надёжно.

Так как RPS на чтение велик (проверка авторизации при каждом обращении к бэкэнду), а на запись относительно мал, то используем репликацию master-slave, где master будет отвечать за запись и чтение, а slave только за чтение. 

Так как поиск в таблице осуществляется по полю `user_id`, создадим для него индекс.

###  S3 хранилище
S3 хранилище для `аватарок`, `вложений в сообщениях` и `голосовых сообщений`. Данные имеют большой объём, поэтому выбираем технологию S3 для их хранения и быстрого доступа. Целесообразно воспользоваться услугами облачных провайдеров по типу **Yandex Object Storage** (предпочтительнее по географическому расположению) или **Amazon S3**.

## Выбор технологий

| Технология            | Область примененения | Мотивация                                                                                                                                                                                                                                                                                                                                                                                         |
| --------------------- | -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| React                 | Frontend             | Фреймворк, позволяющий удобно вести разработку, разделяя код на модули                                                                                                                                                                                                                                                                                                                            |
| Typescript            | Frontend             | Статическая типизация, упрощает процесс разработки, позволяя ловить баги на моменте "сборки"                                                                                                                                                                                                                                                                                                      |
| Redux                 | Frontend             | Хранилище состояний. Уменьшение связей между компонентами путём введения глобаьного состояния приложения                                                                                                                                                                                                                                                                                          |
| Webpack + babel       | Fronend              | Сборка приложения, сжатие кода для уменьшения размера файла при передачи клиенту                                                                                                                                                                                                                                                                                                                  |
| Go                    | Backend              | Многопоточность и асинхронность из коробки, большое количество библиотек для работы по http (роутеры, парсеры и т.п.)                                                                                                                                                                                                                                                                             |
| PostrgeSQL            | Backend              | Реляционная БД с возможностью оптимизации и ускорения при хранении больших объёмов данных. Популярна, большое комьюнити, хорошая поддержка                                                                                                                                                                                                                                                        |
| Tarantool             | Backend              | in-memory БД для хранения сессий пользователей. Обладает очень малым времени обработки запроса на чтение и запись, популярна, большое комьюнити. Шардирование, репликация, балансировка, роутинг.                                                                                                                                                                                                 |
| Yandex Object Storage | Backend              | S3 хранилище для медиафайлов (аватарки, вложения в сообщениях, голосовые сообщения). Приемлимая стоимость, удобное расположение дата-центров. Отличная поддержка и работа с большими объёмами данных                                                                                                                                                                                              |
| Prometheus            | Мониторинг           | Сборка метрик с приложения для анализа работы, распределения нагрузки и поиска узких мест                                                                                                                                                                                                                                                                                                         |
| Graphana              | Мониторинг           | Удобный инструмент для работы с метриками путём построения наглядных дашбордов. Очень гибкая настройка под любые нужды                                                                                                                                                                                                                                                                            |
| Nginx                 | Frontend             | L7 балансировщик, отдача статики, кеширование                                                                                                                                                                                                                                                                                                                                                     |
| Swift + SwiftUI       | Mobile IOS           | Исследования показывают, что число пользователей с мобильных устройств с каждым годом растёт и вытесняет ПК. IOS- одна из самых популярных ОС в мире, в том числе и СНГ, поэтому наличие мобильного приложения де-факто стандарт. Swift наиболее распространенный и поддерживаемый ЯП для IOS устройств. RxSwift вносит реактивность, что позволяет объединять архитектуры Пк версии и IOS версии |
| Kotlin + RxKotlin     | Mobile Android       | Android - самая популярная ОС в мире. Наличие мобильного приложения под Android позвляет дать комфортное использование продукта большому числа людей. RxKotlin позволяет писать рективные приложения.                                                                                                                                                                                             |

## Схема проекта
![схема проекта](/imgs/app_scheme.png)

Архитектура: Микросервисная
Балансировка: Сетевой + транспортный + прикладной уровень


## Список литературы
[^1]: [Исследование соцсетей и мессенджеров](https://vk.com/press/mediascope-october-2022)

[^2]: [Статистика ВК за 1 кв. 2022 г.](https://habr.com/ru/news/t/663492/)

[^3]: [Статистика Вконтакте](https://3dnews.ru/1061274/auditoriya-vkontakte-v-rossii-virosla-do-725-mln-polzovateley-v-2021-godu)

[^4]: [География Вконтакте](https://yandex.ru/images/search?pos=4&img_url=http%3A%2F%2Fmyslide.ru%2Fdocuments_4%2Ff4c31844a42fc2099f9afe5bc0b49186%2Fimg23.jpg&text=%D1%80%D0%B0%D1%81%D0%BF%D1%80%D0%B5%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B0%D1%83%D0%B4%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%B8%20%D0%B2%D0%BA%20%D0%BF%D0%BE%20%D1%81%D1%82%D1%80%D0%B0%D0%BD%D0%B0%D0%BC&lr=213&rpt=simage&source=serp)

[^5]: [Количество созданных чатов за день](https://team.vk.company/vacancy/30137/)

[^6]: [Длина имени и фамилии](https://ch-pik.ru/kakova-sredniaia-dlina-familii)

[^7]: [Посещаемость мессенджеров за день](https://www.cnews.ru/news/top/2018-02-28_whatsapp_stal_samym_populyarnym_messendzheram_v)

[^8]: [Распределении аудитории по мессенджерам в СНГ](https://wciom.ru/analytical-reviews/analiticheskii-obzor/rossiiskaja-auditorija-socialnykh-setei-i-messendzherov-izmenenija-na-fone-specoperacii)